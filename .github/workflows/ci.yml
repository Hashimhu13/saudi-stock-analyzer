name: Saudi Stock Analyzer CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: [3.8, 3.9, 3.10, 3.11]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create reports directory
      run: |
        mkdir -p reports
    
    - name: Test imports
      run: |
        python -c "import flask, pandas, requests, bs4, selenium; print('All imports successful')"
    
    - name: Basic syntax check
      run: |
        python -m py_compile stock_web_app.py
        python -m py_compile config.py
        python -m py_compile تقرير_الأسهم_اليومي.py

  security:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: 3.11
    
    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety
    
    - name: Run security scan with bandit
      run: |
        bandit -r . -x ./venv/
      continue-on-error: true
    
    - name: Check dependencies for vulnerabilities
      run: |
        pip install -r requirements.txt
        safety check
      continue-on-error: true