<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محلل الأسهم السعودية</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAAAAABoBQAAFgAAACgAAAAQAAAAIAAAAAEACAAAAAAAAAEAAAAAAAAAAAAAAAEAAAAAAAAAAAAA////AAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }
        
        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .content-area {
            padding: 40px;
        }
        
        .stock-input-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .stock-row {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .stock-row:hover {
            border-color: #3498db;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.1);
        }
        
        .btn-custom {
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary-custom {
            background: linear-gradient(45deg, #3498db, #2980b9);
            border: none;
            color: white;
        }
        
        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.3);
        }
        
        .btn-success-custom {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            border: none;
            color: white;
        }
        
        .btn-danger-custom {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            border: none;
            color: white;
        }
        
        .btn-secondary-custom {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
            border: none;
            color: white;
        }
        
        .results-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
        }
        
        .stock-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stock-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(45deg, #3498db, #2980b9);
        }
        
        .stock-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .stock-card.success::before {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }
        
        .stock-card.error::before {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }
        
        .stock-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .stock-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .stock-symbol {
            background: #3498db;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .metric-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .metric-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .positive {
            color: #27ae60 !important;
        }
        
        .negative {
            color: #e74c3c !important;
        }
        
        .recommendation {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .recommendation.buy {
            background: #d5f4e6;
            color: #27ae60;
        }
        
        .recommendation.sell {
            background: #fdeaea;
            color: #e74c3c;
        }
        
        .recommendation.hold {
            background: #fff3cd;
            color: #856404;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .popular-stocks {
            margin-top: 20px;
        }
        
        .popular-stock-btn {
            margin: 5px;
            padding: 8px 15px;
            border: 1px solid #3498db;
            background: white;
            color: #3498db;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .popular-stock-btn:hover {
            background: #3498db;
            color: white;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #3498db;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- Header -->
            <div class="header">
                <h1><i class="fas fa-chart-line"></i> محلل الأسهم السعودية</h1>
                <p>تحليل شامل للأسهم مع التوقعات وتتبع الأداء</p>
            </div>
            
            <!-- Content Area -->
            <div class="content-area">
                <!-- Stock Input Section -->
                <div class="stock-input-section">
                    <h3 class="mb-4"><i class="fas fa-plus-circle"></i> إدخال الأسهم للتحليل</h3>
                    
                    <div id="stocks-container">
                        <div class="stock-row">
                            <div class="row align-items-center">
                                <div class="col-md-5">
                                    <label class="form-label">رمز السهم</label>
                                    <input type="text" class="form-control stock-symbol-input" placeholder="مثال: 1210">
                                </div>
                                <div class="col-md-5">
                                    <label class="form-label">اسم الشركة</label>
                                    <input type="text" class="form-control stock-name-input" placeholder="مثال: الراجحي">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="button" class="btn btn-danger-custom btn-custom w-100 remove-stock">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <button type="button" class="btn btn-secondary-custom btn-custom me-2" id="add-stock">
                                <i class="fas fa-plus"></i> إضافة سهم آخر
                            </button>
                            <button type="button" class="btn btn-success-custom btn-custom" id="analyze-btn">
                                <i class="fas fa-chart-bar"></i> تحليل الأسهم
                            </button>
                        </div>
                        <button type="button" class="btn btn-primary-custom btn-custom" id="load-popular">
                            <i class="fas fa-star"></i> تحميل الأسهم الشائعة
                        </button>
                    </div>
                    
                    <!-- Popular Stocks -->
                    <div class="popular-stocks" id="popular-stocks" style="display: none;">
                        <h6>الأسهم الشائعة:</h6>
                        <div id="popular-stocks-container"></div>
                    </div>
                </div>
                
                <!-- Results Section -->
                <div id="results-section" style="display: none;">
                    <div class="results-section">
                        <h3 class="mb-4"><i class="fas fa-chart-pie"></i> نتائج التحليل</h3>
                        
                        <!-- Summary Stats -->
                        <div class="summary-stats" id="summary-stats"></div>
                        
                        <!-- Loading -->
                        <div id="loading" class="loading" style="display: none;">
                            <div class="spinner"></div>
                            <h5>جاري تحليل الأسهم...</h5>
                            <p>يرجى الانتظار قد تستغرق العملية دقيقة أو دقيقتين</p>
                            <div class="progress mt-3" style="height: 10px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%" id="progress-bar"></div>
                            </div>
                            <small class="text-muted mt-2" id="loading-status">بدء التحليل...</small>
                        </div>
                        
                        <!-- Results Container -->
                        <div id="results-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>
        $(document).ready(function() {
            let stockCounter = 1;
            
            // Add new stock row
            $('#add-stock').click(function() {
                stockCounter++;
                const newRow = `
                    <div class="stock-row">
                        <div class="row align-items-center">
                            <div class="col-md-5">
                                <label class="form-label">رمز السهم</label>
                                <input type="text" class="form-control stock-symbol-input" placeholder="مثال: 1210">
                            </div>
                            <div class="col-md-5">
                                <label class="form-label">اسم الشركة</label>
                                <input type="text" class="form-control stock-name-input" placeholder="مثال: الراجحي">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <button type="button" class="btn btn-danger-custom btn-custom w-100 remove-stock">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                $('#stocks-container').append(newRow);
            });
            
            // Remove stock row
            $(document).on('click', '.remove-stock', function() {
                if ($('.stock-row').length > 1) {
                    $(this).closest('.stock-row').remove();
                }
            });
            
            // Load popular stocks
            $('#load-popular').click(function() {
                const button = $(this);
                button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> جاري التحميل...');
                
                $.ajax({
                    url: '/popular_stocks',
                    method: 'GET',
                    timeout: 10000,
                    success: function(data) {
                        const container = $('#popular-stocks-container');
                        container.empty();
                        
                        if (data && data.length > 0) {
                            data.forEach(function(stock) {
                                const btn = `<button class="popular-stock-btn" data-symbol="${stock.symbol}" data-name="${stock.name}">
                                    ${stock.name} (${stock.symbol})
                                </button>`;
                                container.append(btn);
                            });
                            
                            $('#popular-stocks').show();
                            showAlert(`تم تحميل ${data.length} سهم شائع`, 'info');
                        } else {
                            showAlert('لم يتم العثور على أسهم شائعة', 'warning');
                        }
                        
                        button.prop('disabled', false).html('<i class="fas fa-star"></i> تحميل الأسهم الشائعة');
                    },
                    error: function(xhr, status) {
                        button.prop('disabled', false).html('<i class="fas fa-star"></i> تحميل الأسهم الشائعة');
                        
                        const errorMessage = status === 'timeout' ? 
                            'انتهت مهلة تحميل الأسهم الشائعة' : 
                            'خطأ في تحميل الأسهم الشائعة';
                        showAlert(errorMessage, 'error');
                    }
                });
            });
            
            // Add popular stock to form
            $(document).on('click', '.popular-stock-btn', function() {
                const symbol = $(this).data('symbol');
                const name = $(this).data('name');
                
                // Find empty row or add new one
                let emptyRow = $('.stock-row').filter(function() {
                    return $(this).find('.stock-symbol-input').val() === '' && 
                           $(this).find('.stock-name-input').val() === '';
                }).first();
                
                if (emptyRow.length === 0) {
                    $('#add-stock').click();
                    emptyRow = $('.stock-row').last();
                }
                
                emptyRow.find('.stock-symbol-input').val(symbol);
                emptyRow.find('.stock-name-input').val(name);
            });
            
            // Analyze stocks
            $('#analyze-btn').click(function() {
                const stocks = [];
                
                $('.stock-row').each(function() {
                    const symbol = $(this).find('.stock-symbol-input').val().trim();
                    const name = $(this).find('.stock-name-input').val().trim();
                    
                    if (symbol && name) {
                        stocks.push({symbol: symbol, name: name});
                    }
                });
                
                if (stocks.length === 0) {
                    showAlert('يرجى إدخال سهم واحد على الأقل', 'warning');
                    return;
                }
                
                // Disable analyze button during processing
                $('#analyze-btn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> جاري التحليل...');
                
                // Show results section and loading
                $('#results-section').show();
                $('#loading').show();
                $('#results-container').empty();
                $('#summary-stats').empty();
                
                // Start progress simulation
                simulateProgress(stocks.length);
                
                // Scroll to results
                $('html, body').animate({
                    scrollTop: $('#results-section').offset().top - 100
                }, 800);
                
                // Send request with timeout
                $.ajax({
                    url: '/analyze',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({stocks: stocks}),
                    timeout: 120000, // 2 minutes timeout
                    success: function(response) {
                        completeProgress();
                        $('#loading').hide();
                        $('#analyze-btn').prop('disabled', false).html('<i class="fas fa-chart-bar"></i> تحليل الأسهم');
                        displayResults(response);
                    },
                    error: function(xhr, status, error) {
                        completeProgress();
                        $('#loading').hide();
                        $('#analyze-btn').prop('disabled', false).html('<i class="fas fa-chart-bar"></i> تحليل الأسهم');
                        
                        let errorMessage = 'حدث خطأ في التحليل';
                        
                        if (status === 'timeout') {
                            errorMessage = 'انتهت مهلة الاتصال - يرجى المحاولة مرة أخرى';
                        } else if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMessage = xhr.responseJSON.error;
                        } else if (xhr.status === 0) {
                            errorMessage = 'خطأ في الاتصال - تحقق من الإنترنت';
                        } else if (xhr.status >= 500) {
                            errorMessage = 'خطأ في الخادم - يرجى المحاولة لاحقاً';
                        }
                        
                        $('#results-container').html(`
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i> ${errorMessage}
                                <br><small>كود الخطأ: ${xhr.status}</small>
                            </div>
                        `);
                    }
                });
            });
            
            // Helper function to show alerts
            function showAlert(message, type = 'info') {
                const alertClass = type === 'warning' ? 'alert-warning' : 
                                 type === 'error' ? 'alert-danger' : 'alert-info';
                
                const alertHtml = `
                    <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                        <i class="fas fa-${type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                
                $('.content-area').prepend(alertHtml);
                
                // Auto dismiss after 5 seconds
                setTimeout(function() {
                    $('.alert').first().fadeOut();
                }, 5000);
            }
            
            // Simulate progress for user feedback
            function simulateProgress(stockCount) {
                let progress = 0;
                const increment = 100 / (stockCount * 10); // Approximate time per stock
                const statuses = [
                    'بدء التحليل...',
                    'الاتصال بالسوق السعودية...',
                    'جلب البيانات...',
                    'تحليل الأسعار...',
                    'البحث عن التوقعات...',
                    'حساب المؤشرات...',
                    'تجهيز النتائج...'
                ];
                let statusIndex = 0;
                
                const progressInterval = setInterval(function() {
                    progress += increment;
                    
                    if (progress > 95) {
                        progress = 95; // Keep some room for actual completion
                    }
                    
                    $('#progress-bar').css('width', progress + '%');
                    
                    // Update status message
                    if (Math.floor(progress / 15) > statusIndex && statusIndex < statuses.length - 1) {
                        statusIndex++;
                        $('#loading-status').text(statuses[statusIndex]);
                    }
                    
                    // Clear interval when progress reaches near completion
                    if (progress >= 95) {
                        clearInterval(progressInterval);
                        $('#loading-status').text('جاري إكمال التحليل...');
                    }
                }, 200);
                
                // Store interval ID for cleanup
                window.progressInterval = progressInterval;
            }
            
            // Complete progress
            function completeProgress() {
                if (window.progressInterval) {
                    clearInterval(window.progressInterval);
                }
                $('#progress-bar').css('width', '100%');
                $('#loading-status').text('تم الانتهاء!');
            }
            
            function displayResults(data) {
                // Display summary stats
                const summaryHtml = `
                    <div class="stat-card">
                        <div class="stat-number">${data.total_found}</div>
                        <div class="stat-label">أسهم وُجدت</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.total_requested}</div>
                        <div class="stat-label">أسهم مطلوبة</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${Math.round((data.total_found/data.total_requested)*100)}%</div>
                        <div class="stat-label">نسبة النجاح</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.analysis_time.split(' ')[1].substring(0,5)}</div>
                        <div class="stat-label">وقت التحليل</div>
                    </div>
                `;
                $('#summary-stats').html(summaryHtml);
                
                // Display individual results
                let resultsHtml = '';
                
                data.results.forEach(function(stock) {
                    if (stock.status === 'success') {
                        const changeClass = stock.price_change >= 0 ? 'positive' : 'negative';
                        const changeIcon = stock.price_change >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                        const returnClass = stock.potential_return >= 0 ? 'positive' : 'negative';
                        const returnIcon = stock.potential_return >= 0 ? 'fa-rocket' : 'fa-arrow-down';
                        
                        let recommendationClass = 'hold';
                        if (stock.recommendation && stock.recommendation.includes('شراء')) {
                            recommendationClass = 'buy';
                        } else if (stock.recommendation && stock.recommendation.includes('بيع')) {
                            recommendationClass = 'sell';
                        }
                        
                        resultsHtml += `
                            <div class="stock-card success">
                                <div class="stock-header">
                                    <div>
                                        <div class="stock-name">${stock.name}</div>
                                        <span class="stock-symbol">${stock.symbol}</span>
                                    </div>
                                    <div class="recommendation ${recommendationClass}">
                                        ${stock.recommendation || 'غير متوفر'}
                                    </div>
                                </div>
                                
                                <div class="metrics-grid">
                                    <div class="metric-item">
                                        <div class="metric-value">${stock.current_price.toFixed(2)}</div>
                                        <div class="metric-label">السعر الحالي</div>
                                    </div>
                                    <div class="metric-item">
                                        <div class="metric-value">${stock.first_price.toFixed(2)}</div>
                                        <div class="metric-label">السعر الأول</div>
                                    </div>
                                    <div class="metric-item">
                                        <div class="metric-value ${changeClass}">
                                            <i class="fas ${changeIcon}"></i>
                                            ${stock.price_change.toFixed(2)} (${stock.price_change_percent.toFixed(2)}%)
                                        </div>
                                        <div class="metric-label">التغير</div>
                                    </div>
                                    <div class="metric-item">
                                        <div class="metric-value">${stock.target_price ? stock.target_price.toFixed(2) : 'غير متوفر'}</div>
                                        <div class="metric-label">السعر المستهدف</div>
                                    </div>
                                    <div class="metric-item">
                                        <div class="metric-value ${returnClass}">
                                            <i class="fas ${returnIcon}"></i>
                                            ${stock.potential_return.toFixed(2)}%
                                        </div>
                                        <div class="metric-label">العائد المحتمل</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        resultsHtml += `
                            <div class="stock-card error">
                                <div class="stock-header">
                                    <div>
                                        <div class="stock-name">${stock.name}</div>
                                        <span class="stock-symbol">${stock.symbol}</span>
                                    </div>
                                </div>
                                <div class="alert alert-danger mb-0">
                                    <i class="fas fa-exclamation-circle"></i> ${stock.error}
                                </div>
                            </div>
                        `;
                    }
                });
                
                $('#results-container').html(resultsHtml);
            }
        });
    </script>
</body>
</html>